name: Sync codex-ready issues to markdown

on:
  issues:
    types: [opened, edited, labeled, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  sync:
    if: contains(toJson(github.event.issue.labels), 'codex-ready')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate markdown file
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = require("path");

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = context.payload.issue.number;

            const { data } = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber
            });

            const labels = (data.labels || [])
              .map(l => (typeof l === "string" ? l : l.name))
              .filter(Boolean);

            const dir = path.join(process.cwd(), "docs", "issues");
            fs.mkdirSync(dir, { recursive: true });

            const filePath = path.join(dir, `issue-${data.number}.md`);

            const header =
              "# Issue #" + data.number + ": " + data.title + "\n\n" +
              "- State: " + data.state + "\n" +
              "- URL: " + data.html_url + "\n" +
              "- Labels: " + (labels.join(", ") || "(none)") + "\n" +
              "- Updated: " + data.updated_at + "\n\n";

            const body = ((data.body || "").trim() + "\n");
            fs.writeFileSync(filePath, header + body, "utf8");

            core.info(`Wrote ${filePath}`);

      - name: Create or update PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/sync-issues-to-md
          title: "chore: sync codex-ready issues to markdown"
          commit-message: "chore: sync issues to markdown"
          body: "Sync issues labeled codex-ready into docs/issues/."
          labels: automation
